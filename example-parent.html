<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Code-server Iframe Integration Example</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background-color: #2c3e50;
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        margin: 0;
        font-size: 24px;
      }

      .status {
        background-color: #34495e;
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 14px;
      }

      .controls {
        padding: 20px;
        background-color: #ecf0f1;
        border-bottom: 1px solid #bdc3c7;
      }

      .controls h3 {
        margin-top: 0;
        color: #2c3e50;
      }

      .token-input {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
      }

      .button {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }

      .button:hover {
        background-color: #2980b9;
      }

      .button.success {
        background-color: #27ae60;
      }

      .button.success:hover {
        background-color: #229954;
      }

      .button.danger {
        background-color: #e74c3c;
      }

      .button.danger:hover {
        background-color: #c0392b;
      }

      .iframe-container {
        position: relative;
        height: 80vh;
        min-height: 600px;
      }

      .iframe-container iframe {
        width: 100%;
        height: 100%;
        border: none;
      }

      .log {
        background-color: #2c3e50;
        color: #ecf0f1;
        padding: 15px;
        height: 150px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
        line-height: 1.4;
      }

      .log-entry {
        margin-bottom: 5px;
        padding: 2px 0;
      }

      .log-entry.info {
        color: #3498db;
      }

      .log-entry.success {
        color: #27ae60;
      }

      .log-entry.error {
        color: #e74c3c;
      }

      .auto-auth {
        display: flex;
        align-items: center;
        margin: 10px 0;
      }

      .auto-auth input[type="checkbox"] {
        margin-right: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Code-Server Iframe Integration</h1>
        <div class="status" id="status">Ready</div>
      </div>

      <div class="controls">
        <h3>Authentication Configuration</h3>

        <div class="auto-auth">
          <input type="checkbox" id="autoAuth" checked />
          <label for="autoAuth">Automatically send tokens when iframe is ready</label>
        </div>

        <div>
          <label for="accessToken">Access Token:</label>
          <input
            type="text"
            id="accessToken"
            class="token-input"
            value="demo-access-token-123"
            placeholder="Enter access token"
          />
        </div>

        <div>
          <label for="refreshToken">Refresh Token:</label>
          <input
            type="text"
            id="refreshToken"
            class="token-input"
            value="demo-refresh-token-456"
            placeholder="Enter refresh token"
          />
        </div>

        <div>
          <button class="button success" onclick="sendTokens()">Send Authentication Tokens</button>
          <button class="button" onclick="clearLog()">Clear Log</button>
          <button class="button danger" onclick="reloadIframe()">Reload Iframe</button>
        </div>
      </div>

      <div class="iframe-container">
        <iframe id="codeServerFrame" src="http://localhost:8080"></iframe>
      </div>

      <div class="log" id="log">
        <div class="log-entry info">Initializing code-server iframe integration...</div>
      </div>
    </div>

    <script>
      class CodeServerIntegration {
        constructor() {
          this.iframe = document.getElementById("codeServerFrame")
          this.log = document.getElementById("log")
          this.status = document.getElementById("status")
          this.autoAuth = document.getElementById("autoAuth")

          this.setupEventListeners()
          this.logMessage("Parent window ready for communication", "info")
        }

        setupEventListeners() {
          // Listen for messages from the iframe
          window.addEventListener("message", (event) => {
            if (event.origin !== "http://localhost:8080") {
              return // Only accept messages from our code-server
            }

            this.handleIframeMessage(event.data)
          })

          // Listen for iframe load
          this.iframe.addEventListener("load", () => {
            this.logMessage("Iframe loaded successfully", "success")
            this.updateStatus("Iframe Loaded")
          })

          // Auto-auth checkbox change
          this.autoAuth.addEventListener("change", (e) => {
            this.logMessage(`Auto-authentication ${e.target.checked ? "enabled" : "disabled"}`, "info")
          })
        }

        handleIframeMessage(data) {
          if (!data || typeof data !== "object") return

          switch (data.type) {
            case "TOKEN_AUTH_READY":
              this.logMessage("Iframe is ready to receive authentication tokens", "info")
              this.updateStatus("Auth Ready")

              // Automatically send tokens if auto-auth is enabled
              if (this.autoAuth.checked) {
                setTimeout(() => {
                  this.sendTokens()
                }, 500) // Small delay to ensure iframe is fully ready
              }
              break

            case "AUTH_SUCCESS":
              this.logMessage("Authentication successful in iframe", "success")
              this.updateStatus("Authenticated")
              break

            case "AUTH_FAILED":
              this.logMessage(`Authentication failed: ${data.error || "Unknown error"}`, "error")
              this.updateStatus("Auth Failed")
              break

            default:
              this.logMessage(`Received message: ${JSON.stringify(data)}`, "info")
          }
        }

        sendTokens() {
          const accessToken = document.getElementById("accessToken").value.trim()
          const refreshToken = document.getElementById("refreshToken").value.trim()

          if (!accessToken || !refreshToken) {
            this.logMessage("Please provide both access and refresh tokens", "error")
            return
          }

          const message = {
            type: "AUTH_TOKENS",
            accessToken: accessToken,
            refreshToken: refreshToken,
          }

          this.iframe.contentWindow.postMessage(message, "http://localhost:8080")
          this.logMessage("Authentication tokens sent to iframe", "success")
          this.updateStatus("Tokens Sent")
        }

        logMessage(message, type = "info") {
          const timestamp = new Date().toLocaleTimeString()
          const logEntry = document.createElement("div")
          logEntry.className = `log-entry ${type}`
          logEntry.textContent = `[${timestamp}] ${message}`

          this.log.appendChild(logEntry)
          this.log.scrollTop = this.log.scrollHeight
        }

        updateStatus(status) {
          this.status.textContent = status
        }

        clearLog() {
          this.log.innerHTML = '<div class="log-entry info">Log cleared</div>'
        }

        reloadIframe() {
          this.logMessage("Reloading iframe...", "info")
          this.updateStatus("Reloading")
          this.iframe.src = this.iframe.src
        }
      }

      // Global functions for button clicks
      let integration

      function sendTokens() {
        integration.sendTokens()
      }

      function clearLog() {
        integration.clearLog()
      }

      function reloadIframe() {
        integration.reloadIframe()
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", () => {
        integration = new CodeServerIntegration()
      })
    </script>
  </body>
</html>
